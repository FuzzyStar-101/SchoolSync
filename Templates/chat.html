{% extends "base.html" %}

{% block title %}Chat - SchoolSync Pro{% endblock %}
{% block page_title %}Messages{% endblock %}

{% block content %}
<div class="card" style="height: calc(100vh - 180px);">
    <div style="display: flex; height: 100%;">
        <!-- Left Sidebar - Rooms List -->
        <div style="width: 350px; border-right: 2px solid var(--light); display: flex; flex-direction: column;">
            <div style="padding: 20px; border-bottom: 2px solid var(--light);">
                <button class="btn btn-primary" style="width: 100%;" onclick="openNewChatModal()">
                    <i class="fas fa-plus"></i> New Chat
                </button>
            </div>
            
            <div id="roomsList" style="flex: 1; overflow-y: auto; padding: 10px;"></div>
        </div>

        <!-- Right Panel - Messages -->
        <div style="flex: 1; display: flex; flex-direction: column;">
            <div id="noChatSelected" style="display: flex; flex-direction: column; align-items: center; justify-content: center; height: 100%; color: var(--secondary);">
                <i class="fas fa-comments" style="font-size: 64px; margin-bottom: 20px; opacity: 0.3;"></i>
                <h3>Select a chat to start messaging</h3>
            </div>

            <div id="chatContainer" style="display: none; flex: 1; flex-direction: column; height: 100%;">
                <!-- Chat Header -->
                <div style="padding: 20px; border-bottom: 2px solid var(--light); background: white;">
                    <h3 id="currentChatName" style="color: var(--dark); margin: 0;"></h3>
                    <div id="typingIndicator" style="display: none; color: var(--secondary); font-size: 13px; margin-top: 5px;">
                        <i class="fas fa-circle" style="font-size: 8px; animation: pulse 1s infinite;"></i>
                        Someone is typing...
                    </div>
                </div>

                <!-- Messages Area -->
                <div id="messagesArea" style="flex: 1; overflow-y: auto; padding: 20px; background: var(--light);"></div>

                <!-- Input Area -->
                <div style="padding: 20px; border-top: 2px solid var(--light); background: white;">
                    <div style="display: flex; gap: 10px;">
                        <input type="text" id="messageInput" class="form-control" placeholder="Type a message..." 
                               style="flex: 1;" onkeypress="handleKeyPress(event)" oninput="handleTyping()">
                        <button class="btn btn-primary" onclick="sendMessage()">
                            <i class="fas fa-paper-plane"></i> Send
                        </button>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- New Chat Modal -->
<div class="modal" id="newChatModal">
    <div class="modal-content" style="max-width: 500px;">
        <div class="modal-header">
            <h2>New Chat</h2>
            <button class="close-modal" onclick="closeNewChatModal()">
                <i class="fas fa-times"></i>
            </button>
        </div>
        <div class="modal-body">
            <div class="form-group">
                <label>Search Users</label>
                <input type="text" class="form-control" id="userSearch" placeholder="Search by name..." 
                       oninput="searchUsers()" minlength="2">
                <small style="color: var(--secondary);">Type at least 2 characters</small>
            </div>
            
            <div id="searchResults" style="max-height: 300px; overflow-y: auto; margin: 15px 0;"></div>
            
            <div id="selectedUsers" style="display: none; margin-bottom: 15px;">
                <label>Selected Users:</label>
                <div id="selectedUsersList" style="display: flex; gap: 8px; flex-wrap: wrap; margin-top: 8px;"></div>
            </div>
            
            <div class="form-group" id="groupNameField" style="display: none;">
                <label>Group Name <span style="color: var(--danger);">*</span></label>
                <input type="text" class="form-control" id="groupName" placeholder="Enter group name...">
            </div>
            
            <button class="btn btn-primary" style="width: 100%;" onclick="createChat()">
                <i class="fas fa-comment"></i> Create Chat
            </button>
        </div>
    </div>
</div>

<style>
    .room-item {
        padding: 15px;
        border-radius: 10px;
        cursor: pointer;
        transition: all 0.3s;
        margin-bottom: 8px;
    }
    
    .room-item:hover {
        background: var(--light);
    }
    
    .room-item.active {
        background: var(--primary);
        color: white;
    }
    
    .room-item.active .room-name,
    .room-item.active .room-preview {
        color: white;
    }
    
    .room-name {
        font-weight: 600;
        color: var(--dark);
        margin-bottom: 5px;
    }
    
    .room-preview {
        font-size: 13px;
        color: var(--secondary);
        overflow: hidden;
        text-overflow: ellipsis;
        white-space: nowrap;
    }
    
    .message {
        margin-bottom: 15px;
        display: flex;
        gap: 10px;
    }
    
    .message.own {
        flex-direction: row-reverse;
    }
    
    .message-bubble {
        max-width: 60%;
        padding: 12px 15px;
        border-radius: 15px;
        background: white;
        box-shadow: 0 2px 5px rgba(0,0,0,0.05);
    }
    
    .message.own .message-bubble {
        background: var(--primary);
        color: white;
    }
    
    .message-sender {
        font-weight: 600;
        font-size: 13px;
        margin-bottom: 5px;
    }
    
    .message.own .message-sender {
        color: rgba(255,255,255,0.9);
    }
    
    .message-time {
        font-size: 11px;
        color: var(--secondary);
        margin-top: 5px;
    }
    
    .message.own .message-time {
        color: rgba(255,255,255,0.7);
    }
    
    .user-result {
        padding: 12px;
        border: 2px solid var(--light);
        border-radius: 10px;
        margin-bottom: 8px;
        cursor: pointer;
        transition: all 0.3s;
    }
    
    .user-result:hover {
        border-color: var(--primary);
        background: var(--light);
    }
    
    .user-result.selected {
        background: var(--primary);
        color: white;
        border-color: var(--primary);
    }
    
    .user-tag {
        background: var(--primary);
        color: white;
        padding: 6px 12px;
        border-radius: 20px;
        font-size: 13px;
        display: inline-flex;
        align-items: center;
        gap: 6px;
    }
    
    .user-tag i {
        cursor: pointer;
    }
</style>

{% endblock %}

{% block extra_js %}
<script src="https://cdnjs.cloudflare.com/ajax/libs/socket.io/4.5.4/socket.io.min.js"></script>
<script>
    let socket;
    let currentRoomId = null;
    let selectedUsersForChat = [];
    let typingTimeout;
    const currentUserId = '{{ session.user_id }}';
    const currentUserName = '{{ session.name }}';

    document.addEventListener('DOMContentLoaded', () => {
        connectSocket();
        loadRooms();
    });

    function connectSocket() {
        socket = io({
            transports: ['websocket', 'polling']
        });

        socket.on('connect', () => {
            console.log('Socket connected');
        });

        socket.on('receive_message', (data) => {
            if (currentRoomId === data.room_id) {
                appendMessage(data);
            }
        });

        socket.on('user_typing', (data) => {
            if (currentRoomId && data.user_id !== currentUserId) {
                document.getElementById('typingIndicator').style.display = 'block';
            }
        });

        socket.on('user_stop_typing', () => {
            document.getElementById('typingIndicator').style.display = 'none';
        });
    }

    async function loadRooms() {
        const response = await fetch('/api/chat/rooms');
        const rooms = await response.json();
        
        const container = document.getElementById('roomsList');
        container.innerHTML = rooms.map(room => `
            <div class="room-item" onclick="selectRoom('${room.room_id}', '${room.room_name}')">
                <div class="room-name">${room.room_name}</div>
                <div class="room-preview">${room.last_message || 'No messages yet'}</div>
            </div>
        `).join('');
    }

    async function selectRoom(roomId, roomName) {
        currentRoomId = roomId;
        document.getElementById('currentChatName').textContent = roomName;
        
        // Update active state
        document.querySelectorAll('.room-item').forEach(item => item.classList.remove('active'));
        event.target.closest('.room-item').classList.add('active');
        
        // Show chat container
        document.getElementById('noChatSelected').style.display = 'none';
        document.getElementById('chatContainer').style.display = 'flex';
        
        // Join room
        socket.emit('join_room', { room_id: roomId });
        
        // Load messages
        await loadMessages(roomId);
    }

    async function loadMessages(roomId) {
        const response = await fetch(`/api/chat/messages/${roomId}?page=1`);
        const messages = await response.json();
        
        const container = document.getElementById('messagesArea');
        container.innerHTML = messages.map(msg => renderMessage(msg)).join('');
        container.scrollTop = container.scrollHeight;
    }

    function renderMessage(msg) {
        const isOwn = msg.sender_id === currentUserId;
        const time = new Date(msg.timestamp).toLocaleTimeString('en-US', { hour: '2-digit', minute: '2-digit' });
        
        return `
            <div class="message ${isOwn ? 'own' : ''}">
                <div class="message-bubble">
                    ${!isOwn ? `<div class="message-sender">${msg.sender_name}</div>` : ''}
                    <div>${msg.message}</div>
                    <div class="message-time">${time}</div>
                </div>
            </div>
        `;
    }

    function appendMessage(data) {
        const container = document.getElementById('messagesArea');
        container.innerHTML += renderMessage({
            sender_id: data.sender_id,
            sender_name: data.sender_name,
            message: data.message,
            timestamp: data.timestamp
        });
        container.scrollTop = container.scrollHeight;
    }

    function sendMessage() {
        const input = document.getElementById('messageInput');
        const message = input.value.trim();
        
        if (!message || !currentRoomId) return;
        
        socket.emit('send_message', {
            room_id: currentRoomId,
            message: message
        });
        
        input.value = '';
    }

    function handleKeyPress(event) {
        if (event.key === 'Enter') {
            sendMessage();
        }
    }

    let typingTimer;
    function handleTyping() {
        if (!currentRoomId) return;
        
        socket.emit('typing', { room_id: currentRoomId });
        
        clearTimeout(typingTimer);
        typingTimer = setTimeout(() => {
            socket.emit('stop_typing', { room_id: currentRoomId });
        }, 1000);
    }

    // New Chat Functions
    function openNewChatModal() {
        document.getElementById('newChatModal').classList.add('active');
    }

    function closeNewChatModal() {
        document.getElementById('newChatModal').classList.remove('active');
        document.getElementById('userSearch').value = '';
        document.getElementById('searchResults').innerHTML = '';
        selectedUsersForChat = [];
        updateSelectedUsers();
    }

    let searchTimeout;
    async function searchUsers() {
        const query = document.getElementById('userSearch').value;
        if (query.length < 2) {
            document.getElementById('searchResults').innerHTML = '';
            return;
        }
        
        clearTimeout(searchTimeout);
        searchTimeout = setTimeout(async () => {
            const response = await fetch(`/api/chat/users?q=${query}`);
            const users = await response.json();
            
            const container = document.getElementById('searchResults');
            container.innerHTML = users.map(user => `
                <div class="user-result ${selectedUsersForChat.includes(user.user_id) ? 'selected' : ''}" 
                     onclick="toggleUser('${user.user_id}', '${user.name}')">
                    <strong>${user.name}</strong>
                    <div style="color: var(--secondary); font-size: 13px;">${user.role} â€¢ ${user.username}</div>
                </div>
            `).join('');
        }, 300);
    }

    function toggleUser(userId, userName) {
        const index = selectedUsersForChat.findIndex(u => u.id === userId);
        if (index > -1) {
            selectedUsersForChat.splice(index, 1);
        } else {
            selectedUsersForChat.push({ id: userId, name: userName });
        }
        updateSelectedUsers();
        searchUsers(); // Refresh search results
    }

    function updateSelectedUsers() {
        const container = document.getElementById('selectedUsersList');
        const field = document.getElementById('selectedUsers');
        const groupField = document.getElementById('groupNameField');
        
        if (selectedUsersForChat.length === 0) {
            field.style.display = 'none';
            groupField.style.display = 'none';
        } else {
            field.style.display = 'block';
            groupField.style.display = selectedUsersForChat.length > 1 ? 'block' : 'none';
            
            container.innerHTML = selectedUsersForChat.map(user => `
                <span class="user-tag">
                    ${user.name}
                    <i class="fas fa-times" onclick="toggleUser('${user.id}', '${user.name}')"></i>
                </span>
            `).join('');
        }
    }

    async function createChat() {
        if (selectedUsersForChat.length === 0) {
            alert('Please select at least one user');
            return;
        }
        
        const groupName = document.getElementById('groupName').value;
        if (selectedUsersForChat.length > 1 && !groupName) {
            alert('Please enter a group name');
            return;
        }
        
        try {
            const response = await fetchWithCSRF('/api/chat/rooms', {
                method: 'POST',
                body: JSON.stringify({
                    members: selectedUsersForChat.map(u => u.id),
                    room_name: groupName
                })
            });
            
            if (response.ok) {
                const data = await response.json();
                closeNewChatModal();
                await loadRooms();
                selectRoom(data.room_id, groupName || selectedUsersForChat[0].name);
            }
        } catch (error) {
            console.error('Failed to create chat:', error);
            alert('Failed to create chat');
        }
    }

    window.onclick = function(event) {
        if (event.target === document.getElementById('newChatModal')) {
            closeNewChatModal();
        }
    }
</script>
{% endblock %}